<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>BPM Counter</title>
    <style>
      .container{
        font-family: "Courier New", Courier, "Lucida Sans Typewriter";
        width: 400px;
        height: 190px;
        border: 2px solid #d2d2d2;
        background-color: #007bff;
        border-radius: 20px;
      }
      .title {
        text-align: center;
        font-size: 25px;
        color: white;
        border-bottom: #d2d2d2 2px solid;
        border-radius: 20px 20px 0px 0px;
      }
      .result{
        margin-top: 20px;
        width: 200px;
        text-align: center;
        padding: 30px 0px;
        font-size: 25px;
        color: white;
        background-color: #d2d2d2;
        border-radius: 10px;
      }
      .player{
        margin-top: 5px;
        text-align: center;
      }
      .player button {
        background-color: #d2d2d2;
        border-radius: 5px;
        color: white;
      }
      .logo{
        position: relative;
        left: 340px;
        bottom: 40px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title">
        BPM Counter
      </div>
      <div class="clicker" align="center">
          <button class="result" onclick="updateResult()">
            TAP
          </button>
      </div>
      <div class="player">
        <button class="controler" onclick="togglePlayerOutput()">
          &#9654;
        </button>
      </div>
      <div class="logo">
        <a href="https://www.youtube.com/channel/UC0eSD-tdiJMI5GQTkMmZ-6w/videos">
        <svg x="0px" y="0px" width="10vh" viewBox="0 0 680 420" enable-background="new 0 0 340 333" xml:space="preserve">
              <path fill="none" stroke="white" stroke-width="5" stroke-miterlimit="2000" class="path" d="m 150.09026,408.45969 c -2.83318,-0.74304 -3.97084,-1.24341 -6.07376,-2.67147 -1.05932,-0.71937 -10.14701,-9.65583 -22.59081,-22.21485 -23.565566,-23.78376 -22.624416,-22.65963 -22.610066,-27.00603 0.008,-2.45445 0.072,-2.69697 1.427516,-5.41944 2.31119,-4.64181 2.84047,-8.64552 1.72137,-13.0212 -2.034096,-7.95324 -8.998066,-13.43634 -17.107366,-13.46952 -3.46115,-0.0141 -5.59575,0.52191 -9.34548,2.34693 -2.536644,1.23462 -2.947752,1.34379 -5.05983,1.34379 -4.208262,0 -3.136779,0.90897 -27.486711,-23.31762 -20.042172,-19.94064 -21.71994,-21.68763 -22.696095,-23.63238 -2.135295,-4.25409 -2.735859,-8.22579 -1.881441,-12.4425 0.623235,-3.07581 1.748475,-5.59302 3.557136,-7.9575 0.757281,-0.99 52.516121,-52.91988 115.019637,-115.39974 85.43945,-85.407087 114.12089,-113.904627 115.56926,-114.828207 2.98548,-1.90377 6.10659,-2.77302 9.92352,-2.76372 3.64911,0.009 5.77668,0.48702 9,2.02257 2.10543,1.00302 2.80983,1.63803 10.9632,9.88353 l 8.71323,8.81169 13.28808,-13.29063 c 8.60883,-8.61045 13.86075,-13.63767 14.91432,-14.27619 2.89599,-1.75515 5.3031,-2.45919 8.97117,-2.62395 3.92931,-0.17646 6.3669,0.30057 9.75,1.90803 2.18388,1.0377 2.8788,1.70064 23.65053,22.56285 11.77029,11.82159 21.73008,22.00296 22.13289,22.62528 1.04946,1.6215 1.71018,4.44726 1.46193,6.25236 -0.1119,0.81345 -0.79506,2.6946 -1.51818,4.18032 -1.6983,3.48936 -2.22717,5.60064 -2.22717,8.89107 0,4.97106 1.67544,8.97957 5.24532,12.54942 3.49497,3.494997 7.63698,5.236437 12.45468,5.236437 3.07212,0 5.56953,-0.64692 8.97084,-2.32386 2.7024,-1.332357 3.01851,-1.417257 5.27688,-1.417257 4.2348,0 3.03474,-1.01625 27.35874,23.167977 23.77557,23.63898 23.13387,22.90677 24.39441,27.83538 0.7221,2.82339 0.77913,6.69537 0.13866,9.41244 -0.24837,1.05366 -1.00938,3.01116 -1.69113,4.35 -1.23069,2.41677 -2.05719,3.2523 -115.41897,116.67663 -62.7987,62.83332 -114.80124,114.70431 -115.56123,115.26882 -4.62771,3.43755 -10.62273,4.5954 -16.2894,3.14613 -4.4505,-1.13826 -5.19741,-1.70619 -14.91993,-11.34468 l -8.89113,-8.81427 -13.60887,13.63587 c -13.01976,13.04559 -13.70796,13.68342 -15.8976,14.73387 -4.12647,1.97961 -8.86212,2.48619 -13.02815,1.39362 z m 9.82721,-23.93679 5.00373,-5.025 -3.51294,-33.88755 -3.51291,-33.88758 -13.94269,-14.77467 c -12.78826,-13.55136 -14.00491,-14.75712 -14.69411,-14.56245 -0.41327,0.11673 -2.37141,0.21225 -4.35141,0.21225 -3.5394,0 -3.63955,-0.0189 -5.94974,-1.12197 -4.05683,-1.93707 -7.06258,-5.5467 -8.41653,-10.10748 -0.29879,-1.00647 -0.48373,-2.7348 -0.48373,-4.52055 0,-1.78575 0.18494,-3.51408 0.48373,-4.52055 1.35395,-4.56078 4.3597,-8.17041 8.41653,-10.10748 2.34126,-1.11792 2.36381,-1.12197 6.24974,-1.12197 3.88593,0 3.90848,0.004 6.24974,1.12197 4.10552,1.96032 7.1008,5.59164 8.45522,10.2507 0.3838,1.32021 0.48068,2.59725 0.40063,5.28081 l -0.10559,3.53949 14.11884,14.95353 c 7.76535,8.22441 14.94036,15.83352 15.94449,16.90911 l 1.82565,1.95561 3.04521,29.69439 c 1.67487,16.33191 3.11613,30.02781 3.2028,30.43533 0.14748,0.69357 0.3048,0.58551 2.46027,-1.68969 1.26651,-1.33686 3.04524,-3.28683 3.95274,-4.33329 0.9075,-1.04646 2.055,-2.27868 2.55,-2.73831 2.34879,-2.18088 32.87952,-32.16915 38.79429,-38.10501 l 6.69429,-6.71814 -34.62504,-34.32825 -34.62504,-34.32825 -4.16925,0 -4.16925,0 -2.34975,-1.12197 c -4.05682,-1.93707 -7.06257,-5.5467 -8.41652,-10.10748 -0.64131,-2.16024 -0.64131,-6.88086 0,-9.0411 1.35395,-4.56078 4.3597,-8.17041 8.41652,-10.10748 2.34126,-1.11792 2.36382,-1.12197 6.24975,-1.12197 3.88593,0 3.90849,0.004 6.24975,1.12197 4.05681,1.93707 7.06257,5.5467 8.41653,10.10748 0.53238,1.79337 0.66102,6.75633 0.21537,8.31021 -0.29943,1.044 -6.22653,-4.99323 51.92556,52.89042 l 17.30724,17.22732 45.19905,-44.97333 45.19905,-44.9733 -4.54278,-4.3554 c -2.49855,-2.39544 -4.53762,-4.46985 -4.53129,-4.6098 0.0165,-0.36618 10.24587,-10.99557 10.58169,-10.99557 0.15438,0 2.3025,1.92375 4.77357,4.275 2.47107,2.35125 4.59297,4.31112 4.71531,4.35525 0.26376,0.0952 35.14095,-34.87572 35.14095,-35.23533 0,-0.13572 -8.15742,-8.40336 -18.12759,-18.37251 l -18.12759,-18.12573 -2.79741,0.64863 c -4.3026,0.99765 -6.38433,1.24995 -10.33311,1.25241 -11.17896,0.007 -20.54319,-4.53309 -26.91183,-13.04772 -6.25647,-8.3646 -8.12859,-20.003007 -5.02062,-31.211337 l 0.57267,-2.06517 -3.99321,-4.21173 c -2.19627,-2.31648 -4.82475,-4.95426 -5.84109,-5.86176 -2.05587,-1.8357 -3.1221,-2.90148 -16.73211,-16.725 -5.23905,-5.32125 -9.66381,-9.675 -9.83283,-9.675 -0.42108,0 -34.35528,33.96774 -34.35528,34.38924 0,0.18552 -0.20988,0.51147 -0.46638,0.72435 -1.31823,1.09404 -1.33137,1.07679 6.48171,8.52114 4.11657,3.92229 7.48467,7.2648 7.48467,7.42776 0,0.48783 -10.28151,11.067327 -10.6647,10.973817 -0.19449,-0.0475 -3.75147,-3.32631 -7.9044,-7.28631 -4.89471,-4.667277 -7.73199,-7.166427 -8.06586,-7.104597 -0.52227,0.0968 -23.16504,22.509747 -23.16504,22.930017 0,0.12558 12.25125,13.47834 27.225,29.67273 19.99512,21.62514 27.24897,29.65782 27.31527,30.24813 0.0496,0.44205 -1.06389,10.22463 -2.47455,21.73911 l -2.56482,20.93541 1.65903,1.79193 c 2.99226,3.23199 4.34007,6.75282 4.34007,11.33727 0,1.78575 -0.18495,3.51408 -0.48372,4.52055 -1.35396,4.56078 -4.35972,8.17041 -8.41653,10.10748 -2.34126,1.11792 -2.36382,1.12197 -6.24975,1.12197 -3.88593,0 -3.90849,-0.004 -6.24975,-1.12197 -4.05681,-1.93707 -7.06257,-5.5467 -8.41653,-10.10748 -0.29877,-1.00647 -0.48372,-2.7348 -0.48372,-4.52055 0,-3.20832 0.45288,-5.13039 1.87077,-7.9398 1.11378,-2.20686 4.0668,-5.21442 6.16266,-6.27648 0.86163,-0.43659 1.57242,-0.8928 1.57959,-1.01376 0.007,-0.12099 0.99717,-8.24808 2.19996,-18.06024 l 2.18694,-17.84028 -23.69046,-25.65972 C 194.43682,142.64478 183.18601,130.49133 182.46478,129.75 l -1.31136,-1.34793 -71.84814,71.84769 c -39.51647,39.51621 -71.848136,71.98347 -71.848136,72.14946 0,0.27516 9.684219,9.97956 29.1,29.16063 l 7.35,7.26114 2.07691,-0.58194 c 4.79932,-1.34475 11.35177,-1.83063 15.92309,-1.18071 5.47999,0.77913 11.431086,3.18735 15.477986,6.26343 4.14822,3.15312 8.23846,8.33448 10.17872,12.89403 1.7843,4.19307 2.43254,7.26039 2.60622,12.3321 0.16802,4.90641 -0.0519,7.16073 -1.16546,11.94741 l -0.65079,2.79741 18.12573,18.12759 c 9.96915,9.97017 18.19515,18.12759 18.27996,18.12759 0.0848,0 2.40591,-2.26125 5.15796,-5.025 z M 306.12133,184.07685 c -4.6122,-4.42413 -8.43756,-8.19909 -8.50083,-8.38887 -0.14949,-0.44844 10.1355,-11.18973 10.60581,-11.07639 0.49851,0.12015 17.23083,16.1475 17.23083,16.50486 0,0.42237 -10.2282,11.03397 -10.61973,11.01783 -0.18165,-0.007 -4.10388,-3.63333 -8.71608,-8.05743 z m -27.9,-27.6 c -4.6122,-4.42413 -8.43756,-8.19909 -8.50083,-8.38887 -0.14949,-0.44844 10.1355,-11.18973 10.60581,-11.07639 0.49851,0.12015 17.23083,16.1475 17.23083,16.50486 0,0.42237 -10.2282,11.03397 -10.61973,11.01783 -0.18165,-0.008 -4.10388,-3.63333 -8.71608,-8.05743 z m -27.9,-27.6 c -4.6122,-4.42413 -8.43756,-8.19909 -8.50083,-8.38887 -0.14949,-0.44844 10.1355,-11.18973 10.60581,-11.07639 0.49851,0.12015 17.23083,16.1475 17.23083,16.50486 0,0.42237 -10.2282,11.03397 -10.61973,11.01783 -0.18165,-0.008 -4.10388,-3.63333 -8.71608,-8.05743 z m -9.01419,-7.22895 c -0.10197,-0.165 -0.0425,-0.3 0.1323,-0.3 0.17472,0 0.3177,0.135 0.3177,0.3 0,0.165 -0.0595,0.3 -0.1323,0.3 -0.0727,0 -0.21573,-0.135 -0.3177,-0.3 z m 60.39306,178.40694 80.19264,-80.19306 -4.51785,-4.28703 c -2.48481,-2.35788 -4.51785,-4.42176 -4.51785,-4.58637 0,-0.38706 10.19961,-11.04048 10.57017,-11.04048 0.15438,0 2.3025,1.92375 4.77357,4.275 2.47107,2.35125 4.58607,4.30881 4.70004,4.35015 0.11394,0.0413 12.28944,-12.01827 27.0567,-26.79915 l 26.84952,-26.87433 -18.3,-18.13446 c -14.19885,-14.07042 -18.43446,-18.10557 -18.9,-18.00549 -0.33,0.071 -1.81902,0.40701 -3.30894,0.74682 -14.43153,3.2913 -27.82662,-1.0815 -35.92911,-11.72898 -4.57734,-6.01509 -6.62601,-12.340347 -6.63306,-20.479557 -0.004,-4.33524 0.33804,-7.09641 1.34985,-10.90482 l 0.58578,-2.20482 -14.38626,-14.59518 c -7.91244,-8.02734 -16.08348,-16.28094 -18.15789,-18.34131 l -3.77166,-3.74616 -5.26971,5.24616 c -2.89833,2.88537 -8.37906,8.44977 -12.1794,12.36531 l -6.90969,7.11915 5.95503,6.16266 c 6.96261,7.20534 7.6026,8.2005 7.60413,11.82438 0,2.02989 -0.12759,2.50428 -1.46193,5.4 -1.84524,4.00446 -2.28057,5.7936 -2.23245,9.17463 0.11694,8.214297 6.033,15.416457 14.04531,17.098677 4.30794,0.90447 8.00265,0.35169 12.45,-1.86267 2.71728,-1.35297 2.96874,-1.41945 5.4,-1.42752 4.41624,-0.0147 3.05049,-1.16613 27.64395,23.30553 21.27102,21.16566 21.81921,21.73998 22.84764,23.93598 2.99385,6.39267 2.55918,13.45476 -1.17429,19.07946 -1.06227,1.60038 -11.50626,12.2931 -21.5673,22.08093 -2.97,2.88933 -42.01752,41.89152 -86.77227,86.67147 l -81.37227,81.41814 7.37259,7.575 c 4.05495,4.16625 7.46256,7.575 7.57248,7.575 0.10995,0 36.28659,-36.08688 80.39253,-80.19306 z M 128.39043,274.63092 c 3.96039,-2.02044 5.72155,-7.2609 3.82611,-11.38485 -1.4463,-3.14676 -3.95443,-4.90014 -7.0094,-4.90014 -5.68113,0 -9.5232,6.63447 -7.0094,12.1038 1.99078,4.3314 6.37388,6.12939 10.19269,4.18119 z m 107.10001,-33.3 c 1.60317,-0.81789 2.96355,-2.30451 3.82611,-4.18119 2.51379,-5.46933 -1.32828,-12.1038 -7.00941,-12.1038 -3.05496,0 -5.56311,1.75338 -7.00941,4.90014 -3.18192,6.92298 3.75369,14.66979 10.19271,11.38485 z m -73.2,-6.3 c 1.60317,-0.81789 2.96355,-2.30451 3.82611,-4.18119 2.51379,-5.46933 -1.32828,-12.1038 -7.00941,-12.1038 -5.68113,0 -9.5232,6.63447 -7.00941,12.1038 1.9908,4.3314 6.37389,6.12939 10.19271,4.18119 z"></path>
            </svg>
          </a>
      </div>
    </div>

    <script type="text/javascript">
      const AudioContext = window.AudioContext // Default
                          || window.webkitAudioContext // Safari and old versions of Chrome
                          || false;
      let context;
      let oscillator;
      let bpmRepeaterId;

      const prev_bpms = [60];
      const averaging = 3;
      let prev_click = new Date();
      let isPlayerPlaying = false;
      let average_bpm  = 60;
      let bpmInterval = 1*1000;

      const updateResult = function (){
        const prev_bpm_list_max_length = averaging;
        const result = document.querySelector('.result');
        const currentTime = new Date();
        const interval = (currentTime - prev_click)/1000;
        const bpm = 60/interval;
        console.log("interval ", interval);
        prev_click = currentTime;
        while (prev_bpms.length > prev_bpm_list_max_length){
          prev_bpms.shift();
        }
        prev_bpms.push(bpm);
        average_bpm = prev_bpms.reduce((acc, cVal)=>acc+cVal)/prev_bpms.length;
        bpmInterval = 60/average_bpm *1000;
        console.log(prev_bpms)
        result.innerHTML = average_bpm.toFixed(1);

        if(isPlayerPlaying){
          clearInterval(bpmRepeaterId);
          bpmRepeaterId = setInterval(beep, bpmInterval);
        }
      };

      const togglePlayerOutput = function (){
        const button = document.querySelector('.player button');
        if (!isPlayerPlaying){
          button.innerHTML = '&#9724;';
          bpmRepeaterId = setInterval(beep, bpmInterval);
        }
        else{
          button.innerHTML = '&#9654;';
          clearInterval(bpmRepeaterId);
        }
        isPlayerPlaying = !isPlayerPlaying;
    };

    const beep = function (){
      if(!context) context = new AudioContext();
      oscillator = context.createOscillator();
      oscillator.type = "sine";
      oscillator.start(0);
      oscillator.connect(context.destination);
      setTimeout(()=>{oscillator.disconnect(context.destination)}, 150);
    }

    // space bar trigger
    window.addEventListener('keypress', (e) => {
      if(e.code === 32) updateResult();
    });
    document.querySelector('.clicker button').focus();
  </script>
  </body>
</html>
